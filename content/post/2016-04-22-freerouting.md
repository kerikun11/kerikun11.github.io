---
date: "2016-04-22"
title: "KiCadで自動配線"
categories:
  - "説明記事"
tags:
  - "KiCad"
  - "自動配線"
thumbnail: "icon.png"
---

## 概要

{{< postfig src="kicad.jpg" title="KiCad" >}}

### 自動配線ツールを使おう

KiCadが流行ってきて，使う人が増えてきている．

しかし，自動配線ツールを使っている人は少ない．

それでははもったいない！！

今回は自動配線ツールの使い方を説明する．
<!--more-->

## 自動配線と手動配線の使い分け

### 自動配線だとなんか心配？

これを読んでいる方の中には，**「自動配線なんて使い物にならない．自分でやるのが一番」**と思っている人もいるだろう．

しかし，それは違う．自動配線と手動配線を**上手く使い分ける**ことで，最高の作品が出来上がるのだ．

### どう使い分けるのか

電源周りやアナログ回路，高周波通信回路などはあらかじめ手動配線で行っておく．

あとは余ったデジタル配線を自動配線ツールに任せる．

これなら電気的特性を考慮しつつ，**効率的**に作業をすることができる．

## 配線のコスト(重み)という考え方

### 片面基板でも大丈夫

片面基板(切削基板など)を使うとき，自動配線ツールは一般に使いにくい．なぜならば，片面限定配線にすると，「配線不可能」になり，両面配線にすると切削基板では作成できないからだ．

しかし，僕の使っている自動配線ツールには，**「コスト」**という考え方がある．

### 配線にコストをつける

表面配線のコストを100にして，裏面配線のコストを1にすれば，自然とコストを下げるために裏面配線が優先され，切削基板にぴったりの基板が出来上がるのだ．

また，ビアにもコストがつけられて，できるだけビアを減らすということもできる．

とても**柔軟**なのだ．

## 自動配線ツール使用の流れ

  1. KiCadで回路図を書いて部品の割り当てを行う．(いつも通り)
  1. 部品の配置を行う．(いつも通り)
  1. 必要に応じてデザインルールを設定する．(いつも通り)
  1. 重要な配線を手動で行う．(いつも通り)
  1. KiCadから自動配線用にファイルを出力する．
  1. 自動配線ツールでそのファイルを読み込み，自動配線を行う．
  1. 配線結果をKiCadに取り込み完成！

## 自動配線ツールのインストール

### 必要なもの

  * 自動配線ツール：Freerouting.exe
  * Java SE Runtime Environment 8 (JRE8)

以下からダウンロードできる．  
[Freerouting](https://github.com/freerouting/freerouting/raw/master/binaries/FreeRouting.exe)  
[JRE8](http://www.oracle.com/technetwork/java/javase/downloads/jre8-downloads-2133155.html)  

### インストール

  1. 自分のOSにあったJREをダウンロードする．
  1. 案内に従ってJRE8をインストールする．

Freerouting.exeはインストールする必要はありません．使うときに起動するだけです．

## 使い方

### まずは部品を配置する

KiCadでいつも通りにできるだけ配線が楽になるように部品を配置していく．

{{< postfig src="parts.png" title="基板作成画面" width="480px" >}}

### 必要に応じてデザインルールを設定する

自動配線ツールはデザインルールをしっかり守ってくれる．電源周りは余裕をもって太めにしておく．

### 重要な配線を先に行う

電源回り，アナログ回路，高周波通信回路など，必要があれば手動で配線しておく．

もちろん，全部自動配線に任せてもOK

### 配線情報をdsnファイルに書き出す

  1. 黄色のアイコンの`外部ルータ「Freerouter」とのファイル交換`をクリックする．
  1. `現在のボードを”Specctra DSN”ファイルへエクスポート`を押してdsnファイルを作成する．

{{< postfig src="pcb.png" title="基板作成画面" width="480px" >}}

{{< postfig src="exp.png" title="エクスポート" >}}

### 自動配線ツールの起動

  1. ダウンロードした`Freerouting.exe`を起動する．
  1. 先ほどエクスポートしたdsnファイルを読み込む．

{{< postfig src="freerouting.png" title="Freerouting" >}}

### 自動配線のパラメータの設定

  1. 画面上の`Parameter`タブから`Autoroute`を選択する．
  1. 出てきた画面で`Detail Parameter`をクリックする．
  1. さらに出てきた画面でコストの設定をすることができる．
  1. 特に，切削基板の場合は，表面(F.Cu)のコストを高く設定する．

{{< postfig src="menu.png" title="Freerouting" width="480px" >}}
{{< postfig src="layer.png" title="Freerouting" >}}
{{< postfig src="param.png" title="Freerouting" >}}

### 自動配線開始

画面上部の`Autoroute`ボタンで自動配線を開始すると動き始める．

パソコンのスペックや配線の複雑さによってはかなり時間がかかることがある．僕の場合，長いときは4時間くらいかかった．

{{< postfig src="board.png" title="Freerouting" width="480px" >}}

### 配線結果をsesファイルに書き出し

配線が終わると画面下のステータスバーに`Routing Complete`と出る．

そうなったら，メニューバーの`File`→`Export Specctra Session FIle`をクリックしてsesファイルを作成する．

{{< postfig src="save.png" title="Freerouting" width="480px" >}}

### 配線結果をKiCadへ取り込む

KiCadに戻り，dsnファイルを書き出した時と同じ画面で今度はsesファイルをインポートしたら完成．読み込むときに結線情報データを再構築しますか？と聞かれるのではいを押す．

{{< postfig src="import.png" title="Freerouting" >}}
{{< postfig src="complete.png" title="Freerouting" width="480px" >}}

## トラブルシューティング

### 自動配線ツールでdsnファイルを読み込めない（エラー）

Free Routingは，日本語の文字に対応していない．したがってKiCadのリファレンスや定数などに日本語があるとNGである．「Ω」とかもNGなので気を付けよう．

### 自動配線がデザインルールに違反する

FreeRoutingでdsnファイルを取り込んだ時に，「前の設定を復元しますか？」的なメッセージに対してyesをクリックすると，以前のデザインルールを使用してしまうため，デザインルールに違反する恐れがある．デザインルールを変更したときは，このメッセージにはNoをクリックしよう．

## まとめ

手順が多いですが，慣れてしまうとこれなしでは生きていけなくなります．  
自動配線ツールを上手に使って効率よく作業を進めましょう！

